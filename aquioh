local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- Configurações Globais
local Config = {
    Animatronics = false,
    AnimatronicsNames = false,
    Fuses = false,
    FuseColor = Color3.fromRGB(0, 255, 0),
    MonsterColor = Color3.fromRGB(255, 0, 0)
}

-- Tabelas de Armazenamento
local ActiveESP = {
    Animatronics = {},
    Fuses = {}
}

--------------------------------------------------------------------------------
-- SISTEMA DE UI (RAYFIELD)
--------------------------------------------------------------------------------

local Window = Rayfield:CreateWindow({
    Name = "Snap ESP - Ultimate v6",
    LoadingTitle = "Carregando...",
    LoadingSubtitle = "by Snap",
    ConfigurationSaving = { Enabled = false },
    KeySystem = false,
})

local Tab = Window:CreateTab("Visuals", 4483362458) -- Icone de olho

--------------------------------------------------------------------------------
-- FUNÇÕES CORE (ESP)
--------------------------------------------------------------------------------

local function GetDistance(part)
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and part then
        return (LocalPlayer.Character.HumanoidRootPart.Position - part.Position).Magnitude
    end
    return 0
end

-- Cria Texto Flutuante com Distância
local function CreateBillboard(target, name, color, isActiveFunc)
    local bg = Instance.new("BillboardGui")
    bg.Name = "SnapESP_Info"
    bg.Adornee = target
    bg.Size = UDim2.new(0, 200, 0, 50)
    bg.StudsOffset = Vector3.new(0, 3, 0) -- Altura do texto
    bg.AlwaysOnTop = true
    bg.Parent = target

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = color
    textLabel.TextStrokeTransparency = 0
    textLabel.Font = Enum.Font.GothamBold
    textLabel.TextSize = 15
    textLabel.Parent = bg

    -- Loop de atualização de distância
    local connection
    connection = RunService.RenderStepped:Connect(function()
        if not target or not target.Parent or not isActiveFunc() then
            connection:Disconnect()
            bg:Destroy()
            return
        end
        
        local dist = math.floor(GetDistance(target))
        textLabel.Text = string.format("%s\n[%d m]", name, dist)
        textLabel.Visible = isActiveFunc() -- Só mostra se o toggle estiver ligado
    end)
    
    return bg
end

-- ESP para Animatronics (Usa Highlight - Brilho)
local function AddAnimatronicESP(model)
    if ActiveESP.Animatronics[model] then return end -- Já tem

    -- 1. Highlight (Brilho)
    local hl = Instance.new("Highlight")
    hl.Name = "SnapESP_Highlight"
    hl.FillColor = Config.MonsterColor
    hl.OutlineColor = Color3.new(1, 1, 1)
    hl.FillTransparency = 0.5
    hl.OutlineTransparency = 0
    hl.Parent = model
    hl.Enabled = Config.Animatronics

    -- 2. Nome e Distância
    local root = model.PrimaryPart or model:FindFirstChild("HumanoidRootPart") or model:FindFirstChildWhichIsA("BasePart")
    if root then
        CreateBillboard(root, model.Name, Config.MonsterColor, function() return Config.AnimatronicsNames end)
    end

    ActiveESP.Animatronics[model] = hl

    -- Limpeza se o monstro morrer/sumir
    model.AncestryChanged:Connect(function(_, parent)
        if not parent then
            ActiveESP.Animatronics[model] = nil
        end
    end)
end

-- ESP para Fuses (Usa BoxHandleAdornment - Linhas 3D)
-- Isso é melhor que highlight para itens pequenos e não tem limite de quantidade
local function AddFuseESP(tool)
    if ActiveESP.Fuses[tool] then return end
    
    local handle = tool:FindFirstChild("Handle")
    if not handle then return end

    -- 1. Box Adornment (Caixa em volta)
    local box = Instance.new("BoxHandleAdornment")
    box.Name = "SnapESP_Box"
    box.Adornee = handle
    box.Size = handle.Size + Vector3.new(0.2, 0.2, 0.2)
    box.Color3 = Config.FuseColor
    box.Transparency = 0.4
    box.AlwaysOnTop = true
    box.ZIndex = 5
    box.Parent = handle
    box.Visible = Config.Fuses

    -- 2. Nome
    CreateBillboard(handle, "Fuse", Config.FuseColor, function() return Config.Fuses end)

    ActiveESP.Fuses[tool] = box

    tool.AncestryChanged:Connect(function(_, parent)
        if not parent then
            ActiveESP.Fuses[tool] = nil
        end
    end)
end

--------------------------------------------------------------------------------
-- INTERAÇÃO DA UI
--------------------------------------------------------------------------------

Tab:CreateSection("Animatronics")

Tab:CreateToggle({
    Name = "Ver Animatronics (Highlight)",
    CurrentValue = false,
    Flag = "ToggleAnimatronics",
    Callback = function(Value)
        Config.Animatronics = Value
        -- Atualiza os que já existem
        for _, hl in pairs(ActiveESP.Animatronics) do
            if hl then hl.Enabled = Value end
        end
    end,
})

Tab:CreateToggle({
    Name = "Ver Nomes & Distância",
    CurrentValue = false,
    Flag = "ToggleNames",
    Callback = function(Value)
        Config.AnimatronicsNames = Value
    end,
})

Tab:CreateColorPicker({
    Name = "Cor dos Monstros",
    Color = Color3.fromRGB(255, 0, 0),
    Callback = function(Value)
        Config.MonsterColor = Value
        for _, hl in pairs(ActiveESP.Animatronics) do
            if hl then hl.FillColor = Value end
        end
    end
})

Tab:CreateSection("Itens")

Tab:CreateToggle({
    Name = "Ver Fuses (Fusíveis)",
    CurrentValue = false,
    Flag = "ToggleFuses",
    Callback = function(Value)
        Config.Fuses = Value
        for _, box in pairs(ActiveESP.Fuses) do
            if box then box.Visible = Value end
        end
    end,
})

--------------------------------------------------------------------------------
-- LOOPS DE DETECÇÃO (SEGURANÇA E PERFORMANCE)
--------------------------------------------------------------------------------

-- 1. Monitorar Pasta dos Animatronics
local function MonitorAnimatronics()
    -- Tenta achar a pasta com segurança
    local gameFolder = Workspace:FindFirstChild("Game")
    if not gameFolder then return end
    
    local animsFolder = gameFolder:FindFirstChild("Animatronics")
    if not animsFolder then return end
    
    local targetFolder = animsFolder:FindFirstChild("Animatronics") -- As vezes a pasta é dupla
    if not targetFolder then targetFolder = animsFolder end

    -- Adiciona os atuais
    for _, v in pairs(targetFolder:GetChildren()) do
        if v:IsA("Model") then AddAnimatronicESP(v) end
    end

    -- Escuta novos (Spawn Dinâmico)
    targetFolder.ChildAdded:Connect(function(child)
        if child:IsA("Model") then
            -- Espera um pouco pro modelo carregar as parts
            task.wait(0.5)
            AddAnimatronicESP(child)
        end
    end)
end

-- 2. Monitorar Fuses (Varredura Otimizada)
-- Em vez de DescendantAdded no Workspace todo (que laga), fazemos check periódico
task.spawn(function()
    while true do
        task.wait(2) -- Verifica a cada 2 segundos (muito leve)
        for _, obj in pairs(Workspace:GetDescendants()) do
            if obj:IsA("Tool") and obj.Name == "Fuse" then
                AddFuseESP(obj)
            end
        end
    end
end)

-- Inicializar
MonitorAnimatronics()
Rayfield:Notify({
    Title = "Script Carregado",
    Content = "Snap ESP V6 Ultimate ativado com sucesso.",
    Duration = 5,
    Image = 4483362458,
})
